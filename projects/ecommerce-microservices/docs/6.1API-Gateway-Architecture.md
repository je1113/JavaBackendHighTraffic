# API 게이트웨이 아키텍처

## 개요
API 게이트웨이는 e-commerce 마이크로서비스 시스템의 모든 클라이언트 요청에 대한 단일 진입점 역할을 합니다. Spring Cloud Gateway 2023.0.0 (reactive WebFlux)로 구축되어 라우팅, 인증, 속도 제한을 처리하고 대용량 트래픽 시나리오를 위한 복원력 패턴을 제공합니다.

## 아키텍처 구성 요소

### 1. 핵심 게이트웨이 기능

#### 요청 라우팅
- **동적 서비스 디스커버리**: 자동 서비스 디스커버리를 위한 Eureka 통합
- **로드 밸런싱**: Spring Cloud LoadBalancer를 사용한 클라이언트 측 로드 밸런싱
- **라우트 구성**: `application.yml`의 선언적 라우팅 규칙

```yaml
라우트:
- /api/v1/inventory/** → lb://INVENTORY-SERVICE
- /api/v1/orders/** → lb://ORDER-SERVICE
- /api/inventory/actuator/** → 헬스 체크
- /api/orders/actuator/** → 헬스 체크
```

#### 서킷 브레이커 (Resilience4j)
- **슬라이딩 윈도우**: 10개 요청
- **실패율 임계값**: 50%
- **오픈 상태 대기 시간**: 30초
- **Half-Open 호출**: 3개 허용
- **타임아웃**: 서비스당 3초

### 2. 보안 아키텍처

#### 인증 방법
1. **JWT 토큰 검증**
   - OAuth2 리소스 서버 구성
   - 발급자 URI에 대한 토큰 검증
   - 자동 토큰 인트로스펙션

2. **API 키 인증**
   - 커스텀 헤더: `X-API-Key`
   - API 키별 속도 제한
   - 클라이언트 식별 및 추적

#### 보안 필터 체인
```
요청 → CORS 필터 → 인증 필터 → 인가 필터 → 속도 제한 → 라우트 필터 → 서비스
```

### 3. 속도 제한 구현

#### 기술 스택
- **Bucket4j**: 토큰 버킷 알고리즘 구현
- **Redis**: 분산 속도 제한 저장소
- **JCache**: 캐싱 추상화

#### 속도 제한 구성
```yaml
기본 제한:
- 보충률: 초당 100개 요청
- 버스트 용량: 200개 요청

서비스별 제한:
- Inventory Service: 1000 req/s (버스트: 2000)
- Order Service: 500 req/s (버스트: 1000)
```

#### 속도 제한 키
1. **API 키**: `api-key:{client_name}`
2. **인증된 사용자**: `user:{username}`
3. **IP 주소**: `ip:{client_ip}` (폴백)

### 4. 필터 체인 아키텍처

#### 글로벌 필터 (실행 순서)

1. **GlobalLoggingFilter** (순서: HIGHEST_PRECEDENCE)
   - 모든 요청에 상관관계 ID 추가
   - 요청/응답 세부 정보 로깅
   - 요청 지속 시간 추적

2. **RequestMetricsFilter** (순서: HIGHEST_PRECEDENCE + 1)
   - Prometheus 메트릭 기록
   - 요청 수, 지속 시간, 오류 추적
   - 느린 요청 식별 (>1초)

3. **RateLimitingFilter** (순서: HIGHEST_PRECEDENCE + 10)
   - 속도 제한 적용
   - 속도 제한 헤더 추가
   - 제한 초과시 429 반환

### 5. 이벤트 플로우 및 통합

#### 게이트웨이를 통한 요청 플로우
```
1. 클라이언트 요청 → API 게이트웨이
2. CORS 검증 → 보안 체크
3. 속도 제한 체크 → 라우트 해결
4. 서킷 브레이커 → 로드 밸런서 선택
5. 요청 전달 → 대상 서비스
6. 응답 처리 → 클라이언트 응답
```

#### 메트릭 및 모니터링
- **Prometheus 메트릭**:
  - `gateway.requests.total`: 총 요청 수
  - `gateway.request.duration`: 요청 지연 시간
  - `gateway.errors.total`: 오류 수
  - `gateway.slow.requests`: 느린 요청 수

- **헬스 인디케이터**:
  - Redis 연결성
  - 서킷 브레이커 상태
  - 다운스트림 서비스 디스커버리

#### 게이트웨이가 추가하는 헤더
```
요청 헤더:
- X-Correlation-ID: 고유 요청 식별자
- X-Forwarded-For: 클라이언트 IP 체인
- X-Real-IP: 원본 클라이언트 IP

응답 헤더:
- X-Rate-Limit-Remaining: 남은 요청 수
- X-Rate-Limit-Burst-Capacity: 최대 버스트
- X-Rate-Limit-Retry-After: 대기 시간(초) (429 응답시)
```

### 6. 폴백 메커니즘

#### 서킷 브레이커 폴백
- **Inventory Service**: 캐시된 응답과 함께 SERVICE_UNAVAILABLE 반환
- **Order Service**: 오류 세부 정보와 함께 SERVICE_UNAVAILABLE 반환
- **API Docs**: 최소한의 OpenAPI 스펙 반환

#### 오류 처리
- 일관된 오류 응답을 위한 글로벌 예외 핸들러
- 구조화된 오류 형식:
```json
{
  "timestamp": "2024-01-20T10:15:30",
  "status": 503,
  "error": "Service Unavailable",
  "message": "Inventory Service는 일시적으로 사용할 수 없습니다",
  "path": "/api/v1/inventory/products/123"
}
```

### 7. 성능 최적화

#### 연결 관리
- **Netty 구성**: 높은 동시성을 위해 최적화
- **연결 풀링**: 라우트별 연결 풀
- **Keep-Alive**: 다운스트림 서비스에 대한 지속적인 연결

#### 캐싱 전략
- **응답 캐싱**: 구현되지 않음 (서비스가 캐싱 처리)
- **라우트 캐싱**: 인메모리 라우트 해결
- **디스커버리 캐싱**: 5초 레지스트리 가져오기 간격

### 8. 배포 고려사항

#### 리소스 요구사항
- **메모리**: 2-4GB 힙 (트래픽에 따라)
- **CPU**: 2-4 코어 권장
- **네트워크**: Redis 및 서비스에 대한 낮은 지연 시간

#### 스케일링 전략
- **수평 스케일링**: 로드 밸런서 뒤의 여러 게이트웨이 인스턴스
- **스티키 세션**: 불필요 (상태가 없음)
- **헬스 체크**: `/actuator/health` 엔드포인트

### 9. 보안 모범 사례

1. **전송 보안**: 프로덕션에서는 HTTPS만 사용
2. **헤더 정제**: 민감한 헤더 제거
3. **CORS 구성**: 엄격한 오리진 검증
4. **속도 제한**: 남용 및 DoS 방지
5. **인증**: 다중 인증 방법 지원

### 10. 모니터링 및 디버깅

#### 모니터링할 주요 메트릭
1. **요청 속도**: 라우트별 초당 요청 수
2. **오류율**: 4xx 및 5xx 응답
3. **지연 시간**: P50, P95, P99 백분위수
4. **서킷 브레이커**: 열림/닫힘 상태
5. **속도 제한**: 거부율

#### 디버깅 도구
- **요청 추적**: 상관관계 ID 추적
- **디버그 로깅**: 패키지별 구성 가능
- **Actuator 엔드포인트**: 실시간 게이트웨이 상태
- **Prometheus 메트릭**: 상세한 성능 데이터

### 11. 마이크로서비스와의 통합

#### 서비스 등록
- 서비스는 시작시 Eureka에 등록
- 게이트웨이는 동적으로 서비스 검색
- 인스턴스 간 자동 로드 밸런싱

#### 이벤트 기반 통신
게이트웨이는 동기식 HTTP 트래픽을 처리하지만, 마이크로서비스는 다음을 위해 Kafka를 통해 비동기적으로 통신합니다:
- 주문 생성 이벤트
- 재고 예약 이벤트
- 결제 처리 이벤트

게이트웨이는 이벤트 스트리밍에 참여하지 않지만 이벤트 트리거 작업에 대한 적절한 요청 라우팅을 보장합니다.

### 12. 구성 관리

#### 환경별 구성
- **로컬**: 직접 서비스 URL, 디버그 로깅
- **개발**: Eureka 디스커버리, 완화된 보안
- **프로덕션**: 엄격한 보안, 최적화된 타임아웃

#### 동적 구성
- 재시작 없이 라우트 업데이트
- 속도 제한 조정
- 서킷 브레이커 튜닝

## 요약

API 게이트웨이는 다음과 같은 강력하고 확장 가능한 e-commerce 시스템의 진입점을 제공합니다:
- 고성능 반응형 아키텍처
- 포괄적인 보안 기능
- 유연한 속도 제한
- 복원력 있는 서킷 브레이커
- 상세한 관찰 가능성

이 아키텍처는 시스템이 안정성과 성능을 유지하면서 수백만 명의 동시 사용자를 처리할 수 있도록 보장합니다.